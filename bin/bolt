#!/usr/bin/env bash

SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  # if $SOURCE was a relative symlink, resolve it relative to the path where the symlink file was located
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
BOLT_DIR="$( cd -P "$( dirname "$SOURCE" )/.." && pwd )"

BOLT_VERSION=$(cat "$BOLT_DIR/VERSION")

BOLT_OPERATION=$1

if [ "$BOLT_OPERATION" == "verbose" ];then
  # shellcheck disable=SC2034
  BOLT_VERBOSE=1
  BOLT_OPERATION=$2
  shift
fi

for file in $BOLT_DIR/lib/*.sh; do
  . "$file"
done

help() {
  version
  echo -e "\ncommands:"
  echo "types   - view descriptions for supported assertion types"
  echo "list    - list assertion types (for bash autocomplete)"
  echo "status  - check state of a bolt config"
  echo "          bolt status config.sh"
  echo "satsify - attempt to satisfy assertions in a bolt config"
  echo "          bolt satisfy config.sh"
  echo "check   - check state of a single bolt command"
  echo "          bolt check dir foo"
  echo "do      - satisfy a single bolt command"
  echo "          bolt do dir foo"
  echo ""
  echo "adding \"verbose\" before an assertion command will sometimes"
  echo "add more detail to the operation output (if available)"
  echo "          bolt verbose check yum nano"
  echo ""
}

version() {
  echo "bolt $BOLT_VERSION"
}

# shellcheck disable=SC2086,SC2048,SC2046,SC1010
case $BOLT_OPERATION in
  status|satisfy)
    if [ -f "$2" ];then
      source "$2"; reporter
    else
      echo "Error: cannot read bolt config \"$2\""
      exit 1
    fi
    ;;
  do) BOLT_OPERATION="satisfy"; shift; ok $*; echo -e "\n";;
  check) BOLT_OPERATION="status"; shift; ok $*; echo -e "\n";;
  # generate a list of types for tab autocompletion
  list)
    list=""
    for type in $BOLT_DIR/types/*.sh; do
      list="$list$(basename ${type%.*}) "
    done
    echo "$list"
    ;;
  # print help descriptions for supported types
  types)
    if [ -z $2 ];then
      # for a single type
      for type in $BOLT_DIR/types/*.sh; do
        echo "* $(basename ${type%.*})" && . $type 'desc'
        echo ""
      done
    else
      # for all types
      type=$BOLT_DIR/types/$2.sh
      if [ -f "$type" ];then
        . $type 'desc'
      else
        echo "unsupported type \"$2\""
        exit 1
      fi
    fi
    ;;
  version) version;;
  help|?|*) help;;
esac
